name: Translations

on:
  push:
    paths:
      - '.github/workflows/translations.yml'
      - 'translation/**'
      - 'bin/trans-lint'
      - 'ui/.build/src/i18n.ts'
  pull_request:
    paths:
      - '.github/workflows/translations.yml'
      - 'translation/**'
      - 'bin/trans-lint'
      - 'ui/.build/src/i18n.ts'

jobs:
  xmllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils
      - name: Validate translation files
        run: xmllint --noout --dtdvalid translation/resources.dtd translation/**/*.xml

  trans-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Lint translation files
        run: ./bin/trans-lint translation/dest/*/*.xml

  i18n-key-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          cache: pnpm
      - run: pnpm install
      - run: pnpm i18n-file-gen
      - run: ./ui/build --i18n
      - name: i18n files up-to-date check
        run: |
          git status --porcelain
          git diff
          if [[ -n $(git status --porcelain) ]]; then
              echo "i18n files are out of date. Please run `pnpm i18n-file-gen` and `./ui/build --i18n` and commit the changes.";
              exit 1;
          fi
