import typescriptEslint from '@typescript-eslint/eslint-plugin';
import tsParser from '@typescript-eslint/parser';
import compat from 'eslint-plugin-compat';
import imports from 'eslint-plugin-import';

const barrelHint = 'This script must remain side-effect free.';

function sideEffects(action) {
  return {
    'no-restricted-syntax': [
      action,
      {
        selector: 'Program > ImportDeclaration[importKind!="type"][specifiers.length=0]',
        message: `${barrelHint} No side-effect imports`,
      },
      {
        selector: 'Program > ExpressionStatement:not([directive])',
        message: `${barrelHint} No top-level expressions in index.ts`,
      },
      {
        selector: 'Program > ExpressionStatement > CallExpression',
        message: `${barrelHint} No top-level calls in index.ts`,
      },
      {
        selector: 'Program > ExpressionStatement > NewExpression',
        message: `${barrelHint} No top-level new in index.ts`,
      },
      {
        selector: 'Program > ExpressionStatement > AwaitExpression',
        message: `${barrelHint} No top-level await in index.ts`,
      },
      {
        selector:
          'Program > VariableDeclaration > VariableDeclarator[init.type=/^(CallExpression|NewExpression|UpdateExpression|AssignmentExpression|AwaitExpression|TaggedTemplateExpression)$/]',
        message: `${barrelHint} No side-effectful initializers in index.ts`,
      },
    ],
  };
}

export default [
  { ignores: ['*', '!ui/', '!bin/', '**/dist/'] },
  {
    files: ['**/*.{ts,mts,mjs}'],
    plugins: { '@typescript-eslint': typescriptEslint, compat, imports },
    languageOptions: { parser: tsParser, ecmaVersion: 5, sourceType: 'module' },
    rules: {
      ...sideEffects('off'),
      'compat/compat': 'warn',
      '@typescript-eslint/no-empty-interface': 'off',
      '@typescript-eslint/explicit-module-boundary-types': 'off',
      '@typescript-eslint/no-empty-function': 'off',
      '@typescript-eslint/no-non-null-assertion': 'off',
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-this-alias': 'off',
      'imports/no-duplicates': ['error'],
      '@typescript-eslint/no-unused-vars': [
        'warn',
        { varsIgnorePattern: '^_', argsIgnorePattern: '^_', caughtErrorsIgnorePattern: '^_' },
      ],
      'linebreak-style': ['error', 'unix'],
      'prefer-const': 'error',
      'prefer-spread': 'off',
      'prefer-rest-params': 'off',
      'no-useless-escape': 'off',
      'no-var': 'warn',
      'no-async-promise-executor': 'warn',
      'no-constant-condition': ['warn', { checkLoops: false }],
      'no-restricted-globals': [
        'error',
        'addEventListener',
        'blur',
        'captureEvents',
        'chrome',
        'clientInformation',
        'close',
        'closed',
        'createImageBitmap',
        'crypto',
        'customElements',
        'defaultstatus',
        'defaultStatus',
        'devicePixelRatio',
        'external',
        'find',
        'focus',
        'frameElement',
        'frames',
        'getComputedStyle',
        'getSelection',
        'indexedDB',
        'innerHeight',
        'innerWidth',
        'isSecureContext',
        'length',
        'locationbar',
        'matchMedia',
        'menubar',
        'moveBy',
        'moveTo',
        'name',
        'onabort',
        'onafterprint',
        'onanimationend',
        'onanimationiteration',
        'onanimationstart',
        'onappinstalled',
        'onauxclick',
        'onbeforeinstallprompt',
        'onbeforeprint',
        'onbeforeunload',
        'onblur',
        'oncancel',
        'oncanplay',
        'oncanplaythrough',
        'onchange',
        'onclick',
        'onclose',
        'oncontextmenu',
        'oncuechange',
        'ondblclick',
        'ondevicemotion',
        'ondeviceorientation',
        'ondeviceorientationabsolute',
        'ondrag',
        'ondragend',
        'ondragenter',
        'ondragleave',
        'ondragover',
        'ondragstart',
        'ondrop',
        'ondurationchange',
        'onemptied',
        'onended',
        'onerror',
        'onfocus',
        'ongotpointercapture',
        'onhashchange',
        'oninput',
        'oninvalid',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onlanguagechange',
        'onload',
        'onloadeddata',
        'onloadedmetadata',
        'onloadstart',
        'onlostpointercapture',
        'onmessage',
        'onmessageerror',
        'onmousedown',
        'onmouseenter',
        'onmouseleave',
        'onmousemove',
        'onmouseout',
        'onmouseover',
        'onmouseup',
        'onmousewheel',
        'onoffline',
        'ononline',
        'onpagehide',
        'onpageshow',
        'onpause',
        'onplay',
        'onplaying',
        'onpointercancel',
        'onpointerdown',
        'onpointerenter',
        'onpointerleave',
        'onpointermove',
        'onpointerout',
        'onpointerover',
        'onpointerup',
        'onpopstate',
        'onprogress',
        'onratechange',
        'onrejectionhandled',
        'onreset',
        'onresize',
        'onscroll',
        'onsearch',
        'onseeked',
        'onseeking',
        'onselect',
        'onstalled',
        'onstorage',
        'onsubmit',
        'onsuspend',
        'ontimeupdate',
        'ontoggle',
        'ontransitionend',
        'onunhandledrejection',
        'onunload',
        'onvolumechange',
        'onwaiting',
        'onwebkitanimationend',
        'onwebkitanimationiteration',
        'onwebkitanimationstart',
        'onwebkittransitionend',
        'onwheel',
        'open',
        'openDatabase',
        'opener',
        'origin',
        'outerHeight',
        'outerWidth',
        'pageXOffset',
        'pageYOffset',
        'parent',
        'personalbar',
        'postMessage',
        'print',
        'releaseEvents',
        'removeEventListener',
        'resizeBy',
        'resizeTo',
        'screen',
        'screenLeft',
        'screenTop',
        'screenX',
        'screenY',
        'scroll',
        'scrollbars',
        'scrollBy',
        'scrollTo',
        'scrollX',
        'scrollY',
        //'self',
        'status',
        'statusbar',
        'stop',
        'styleMedia',
        'toolbar',
        'top',
        'visualViewport',
        'webkitRequestFileSystem',
        'webkitResolveLocalFileSystemURL',
        'webkitStorageInfo',
      ],
    },
  },
  {
    files: ['**/index.ts'],
    rules: {
      ...sideEffects('error'),
    },
  },
];
